{% extends "base.html" %}
{% load static %}

{% block content %}
<link rel="stylesheet" href="{% static 'css/progress.css' %}">

<div class="blog-container">
  <!-- Sidebar -->
  <aside class="sidebar">
    <h3>Feedback History</h3>
    <ul id="feedback-history">
      <li>üîÑ Generating your first draft section‚Ä¶</li>
    </ul>
  </aside>

  <!-- Main Content -->
  <main class="main-content">
    <!-- Phase Tracker -->
    <div class="step-tracker">
      <div class="step completed">1. Outline</div>
      <div class="step active">2. Draft</div>
      <div class="step">3. Format</div>
      <div class="step">4. Finalize</div>
    </div>

    <!-- Loader -->
    <div id="loader-section">
      <div class="spinner"></div>
      <p id="loader-text">Generating section draft‚Ä¶</p>
    </div>

    <!-- Section Display -->
    <section id="draft-section" style="display: none;">
      <h2 id="section-title"></h2>
      <div id="section-content" class="outline-list"></div>

      <form id="feedback-form">
        {% csrf_token %}
        <label for="feedback">Any edits or suggestions?</label>
        <textarea id="feedback" rows="3" placeholder="e.g. ‚ÄúShorten intro‚Äù"></textarea>
        <div class="button-group">
          <button type="button" id="looks-good">Looks Good, Next</button>
          <button type="submit">Apply Feedback</button>
        </div>
      </form>
    </section>
  </main>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
document.addEventListener("DOMContentLoaded", () => {
  const outlineId = "{{ draft.outline.id }}";
  const draftId   = "{{ draft.id }}";
  const loader    = document.getElementById("loader-section");
  const loaderText= document.getElementById("loader-text");
  const section   = document.getElementById("draft-section");
  const titleEl   = document.getElementById("section-title");
  const contentEl = document.getElementById("section-content");
  const history   = document.getElementById("feedback-history");
  const form      = document.getElementById("feedback-form");
  const textarea  = document.getElementById("feedback");
  const looksGood = document.getElementById("looks-good");

  // Call DraftSectionView API
  async function fetchDraft(feedback=null) {
    loader.style.display  = "block";
    section.style.display = "none";
    loaderText.textContent = feedback
      ? "Refining this section‚Ä¶"
      : "Generating section draft‚Ä¶";

    const resp = await fetch(`/api/write/${outlineId}/`, {
      method: 'POST',
      headers: {
        'X-CSRFToken': '{{ csrf_token }}',
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({ 
        section_id: draftId,
        feedback: feedback 
      })
    });
    if (!resp.ok) throw new Error(resp.status);
    const data = await resp.json();

    // render
    titleEl.textContent   = data.section_title;
    contentEl.innerText   = data.content;

    loader.style.display  = "none";
    section.style.display = "block";

    const entry = document.createElement("li");
    entry.textContent = feedback
      ? `‚úî Refinement applied: "${feedback}"`
      : "‚úî Section draft ready.";
    history.appendChild(entry);
  }

  // initial load
  fetchDraft().catch(err => {
    console.error(err);
    loader.innerHTML += `<p class="error-msg">‚ùå Could not load draft.</p>`;
  });

  // feedback submit
  form.addEventListener("submit", async e => {
    e.preventDefault();
    const fb = textarea.value.trim();
    if (!fb) return;
    textarea.value = "";
    history.appendChild(Object.assign(document.createElement("li"), {
      textContent: `‚úèÔ∏è Feedback: ${fb}`
    }));
    await fetchDraft(fb).catch(err => {
      console.error(err);
      loader.innerHTML += `<p class="error-msg">‚ùå Retry feedback.</p>`;
    });
  });

  // Looks Good ‚Üí next section or meta
  looksGood.addEventListener("click", () => {
    window.location.href = `{% url 'section_write' outline_id=outlineId %}`;
  });
});
</script>
{% endblock %}
