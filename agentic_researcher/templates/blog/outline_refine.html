{% extends "base.html" %}
{% load static %}

{% block content %}
<link rel="stylesheet" href="{% static 'css/progress.css' %}">

<div class="blog-container">
  <!-- Sidebar -->
  <aside class="sidebar">
    <h3>Feedback History</h3>
    <ul id="feedback-history">
      <li>ğŸ”„ Generating your blog outlineâ€¦</li>
    </ul>
  </aside>

  <!-- Main Content -->
  <main class="main-content">
    <!-- Phase Tracker -->
    <div class="step-tracker">
      <div class="step completed">1. Outline</div>
      <div class="step">2. Draft</div>
      <div class="step">3. Format</div>
      <div class="step">4. Finalize</div>
    </div>

    <!-- Loader -->
    <div id="loader-section">
      <div class="spinner"></div>
      <p id="loader-text">Generating your outline. Please waitâ€¦</p>
    </div>

    <!-- Outline Display -->
    <section id="outline-section" style="display: none;">
      <h2>Hereâ€™s Your Blog Outline</h2>
      <p class="subheading">Review the structure below and let me know any tweaks.</p>
      <ol id="outline-content" class="outline-list"></ol>

      <form id="feedback-form">
        {% csrf_token %}
        <label for="feedback">Any adjustments or notes?</label>
        <textarea name="feedback" id="feedback" rows="3" placeholder="e.g. â€œCombine sections 2 and 3â€"></textarea>
        <div class="button-group">
          <button type="button" id="looks-good">Looks Good, Next</button>
          <button type="submit">Apply Feedback</button>
        </div>
      </form>
    </section>
  </main>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
document.addEventListener("DOMContentLoaded", () => {
  const outlineId = "{{ outline.id }}";
  const loader    = document.getElementById("loader-section");
  const loaderText= document.getElementById("loader-text");
  const section   = document.getElementById("outline-section");
  const list      = document.getElementById("outline-content");
  const history   = document.getElementById("feedback-history");
  const form      = document.getElementById("feedback-form");
  const textarea  = document.getElementById("feedback");
  const looksGood = document.getElementById("looks-good");

  // Utility to call the API (with optional feedback) and render results
  async function fetchOutline(feedback=null) {
    // Show loader
    section.style.display = "none";
    loader.style.display  = "block";
    loaderText.textContent = feedback
      ? "Refining your outlineâ€¦"
      : "Generating your outlineâ€¦";

    // Call API
    const resp = await fetch(`/api/outline/${outlineId}/`, {
      method: 'POST',
      headers: {
        'X-CSRFToken': '{{ csrf_token }}',
        'Content-Type': 'application/json'
      },
      body: feedback ? JSON.stringify({ feedback }) : null
    });
    if (!resp.ok) throw new Error(`Status ${resp.status}`);
    const data = await resp.json();

    // Render
    loader.style.display = "none";
    list.innerHTML = "";  // clear old
    const secs = data.outline_json.sections || [];
    secs.forEach(sec => {
      const li = document.createElement("li");
      li.className = "outline-item";
      li.innerHTML = `
        <h3 class="outline-title">${sec.title}</h3>
        <p class="outline-desc">${sec.description}</p>
      `;
      list.appendChild(li);
    });
    section.style.display = "block";

    // Sidebar entry
    const entry = document.createElement("li");
    entry.textContent = feedback
      ? `âœ” Applied feedback: "${feedback}"`
      : "âœ” Outline ready for review.";
    history.appendChild(entry);
  }

  // Initial generate on load
  fetchOutline().catch(err => {
    console.error(err);
    loader.innerHTML += `<p class="error-msg">âŒ Failed. Try again?</p>`;
  });

  // Handle â€œApply Feedbackâ€
  form.addEventListener("submit", async e => {
    e.preventDefault();
    const fb = textarea.value.trim();
    if (!fb) return;
    textarea.value = "";
    history.appendChild(Object.assign(document.createElement("li"), {
      textContent: `âœï¸ Feedback: ${fb}`
    }));
    await fetchOutline(fb).catch(err => {
      console.error(err);
      loader.innerHTML += `<p class="error-msg">âŒ Retry applying feedback.</p>`;
    });
  });

  // â€œLooks Goodâ€ â†’ move on
  looksGood.addEventListener("click", () => {
    window.location.href = `{% url 'section_write' outline_id=outline.id %}`;
  });
});
</script>
{% endblock %}
