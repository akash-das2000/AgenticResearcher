{% extends "base.html" %}
{% load static %}

{% block content %}
<link rel="stylesheet" href="{% static 'css/progress.css' %}">

<div class="blog-container">
  <!-- Sidebar -->
  <aside class="sidebar">
    <h3>Feedback History</h3>
    <ul id="feedback-history">
      <li>üîÑ Generating your blog outline...</li>
    </ul>
  </aside>

  <!-- Main Content Area -->
  <main class="main-content">
    <!-- Phase Tracker (4 steps) -->
    <div class="step-tracker">
      <div class="step completed">1. Outline</div>
      <div class="step">2. Draft</div>
      <div class="step">3. Format</div>
      <div class="step">4. Finalize</div>
    </div>

    <!-- Loader -->
    <div id="loader-section">
      <div class="spinner"></div>
      <p>Generating your outline. Please wait‚Ä¶</p>
    </div>

    <!-- Outline Content & Feedback -->
    <div id="outline-section" style="display: none;">
      <h2>Step 1: Your Blog Outline</h2>
      <div id="outline-content"></div>

      <form method="post" id="feedback-form">
        {% csrf_token %}
        <label for="feedback">Any tweaks or notes?</label>
        <textarea name="feedback" id="feedback" rows="3" placeholder="Enter feedback‚Ä¶"></textarea>
        <div class="button-group">
          <button type="button" id="looks-good">Looks Good</button>
          <button type="submit">Apply Feedback</button>
        </div>
      </form>
    </div>
  </main>
</div>

<script>
document.addEventListener("DOMContentLoaded", function () {
  // Use the outline object's ID for the API call
  const pk = "{{ outline.id }}";

  // Kick off the outline generation via the backend API
  fetch(`/api/outline/${pk}/`, {
    method: 'POST',
    headers: { 'X-CSRFToken': '{{ csrf_token }}' }
  })
  .then(response => {
    if (!response.ok) throw new Error("Status " + response.status);
    return response.json();
  })
  .then(data => {
    // Hide loader, show outline
    document.getElementById("loader-section").style.display = "none";
    document.getElementById("outline-section").style.display = "block";

    // Render the outline JSON (or adjust to render HTML as needed)
    document.getElementById("outline-content").innerText =
      JSON.stringify(data.outline_json, null, 2);

    // Update sidebar history
    const history = document.getElementById("feedback-history");
    const li = document.createElement("li");
    li.textContent = "‚úî Outline generated successfully.";
    history.appendChild(li);
  })
  .catch(err => {
    console.error("Outline API error:", err);
    const loader = document.getElementById("loader-section");
    loader.querySelector(".spinner").style.display = "none";
    loader.innerHTML += `<p style="color:red;">‚ùå Failed to generate outline. Please try again.</p>`;
  });

  // Feedback form handling
  document.getElementById("feedback-form").addEventListener("submit", function (e) {
    e.preventDefault();
    const text = document.getElementById("feedback").value.trim();
    if (!text) return;
    const history = document.getElementById("feedback-history");
    const li = document.createElement("li");
    li.textContent = `‚úèÔ∏è Feedback: ${text}`;
    history.appendChild(li);
    document.getElementById("feedback").value = '';
    // You could optionally POST this back to the server here
  });

  // ‚ÄúLooks Good‚Äù advances you to the Draft phase
  document.getElementById("looks-good").addEventListener("click", () => {
    window.location.href = `{% url 'section_write' outline_id=outline.id %}`;
  });
});
</script>
{% endblock %}
