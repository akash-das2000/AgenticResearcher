{% extends "base.html" %}
{% load static %}

{% block content %}
  <link rel="stylesheet" href="{% static 'css/progress.css' %}">

  {# two-column, full-height wrapper under the 81px header #}
  <div
    style="
      position: fixed;
      top: 81px;
      bottom: 0;
      left: 0;
      right: 0;
      display: grid;
      grid-template-columns: 20% 1fr;
      overflow: hidden;
    "
  >
    <!-- Left: Feedback History -->
    <aside
      style="
        background: #f4f4f4;
        border-right: 1px solid #ccc;
        padding: 1rem;
        overflow-y: auto;
      "
    >
      <h3>Feedback History</h3>
      <ul id="feedback-history" style="list-style:none; padding:0; margin:0;">
        <li>üîÑ Generating your blog outline‚Ä¶</li>
      </ul>
    </aside>

    <!-- Right: Outline & Form -->
    <main
      class="main-content"
      style="
        display: flex;
        flex-direction: column;
        overflow: hidden;
        padding: 1rem;
        box-sizing: border-box;
      "
    >
      <!-- Step Tracker -->
      <div class="step-tracker" style="display:flex; gap:1rem; flex:none; margin-bottom:1rem;">
        <div class="step completed" style="flex:1; text-align:center; border-bottom:3px solid #28a745;">
          1. Outline
        </div>
        <div class="step" style="flex:1; text-align:center; border-bottom:3px solid #ccc; color:#777;">
          2. Draft
        </div>
        <div class="step" style="flex:1; text-align:center; border-bottom:3px solid #ccc; color:#777;">
          3. Format
        </div>
        <div class="step" style="flex:1; text-align:center; border-bottom:3px solid #ccc; color:#777;">
          4. Finalize
        </div>
      </div>

      <!-- Loader (until outline arrives) -->
      <div
        id="loader-section"
        style="
          flex: 1;
          display: flex;
          flex-direction: column;
          justify-content: center;
          align-items: center;
          overflow: hidden;
        "
      >
        <div class="spinner"></div>
        <p id="loader-text" style="margin-top:0.5rem; font-size:0.9rem;">
          Generating your outline‚Ä¶ Please wait.
        </p>
      </div>

      <!-- Outline + Feedback Form -->
      <!-- NOTE: method="post" and the Looks Good button now submits feedback=OK -->
      <section
        id="outline-section"
        style="
          display: none;
          flex: 1;
          display: flex;
          flex-direction: column;
          overflow: hidden;
        "
      >
        <h2 style="margin:0 0 0.5rem;">Here‚Äôs Your Blog Outline</h2>
        <p style="margin:0 0 1rem; color:#555;">
          Review the structure below and let me know any tweaks.
        </p>

        <ul
          id="outline-content"
          class="outline-list"
          style="
            flex: 1;
            overflow-y: auto;
            list-style: none;
            padding: 0;
            margin: 0 0 1rem;
          "
        ></ul>

        <form
          id="feedback-form"
          method="post"
          style="flex:none; display:flex; flex-direction:column;"
        >
          {% csrf_token %}
          <textarea
            id="feedback"
            name="feedback"
            rows="3"
            placeholder="Any adjustments or notes?"
            style="
              padding:0.5rem;
              font-size:0.9rem;
              border:1px solid #ccc;
              border-radius:4px;
              margin-bottom:0.8rem;
              resize:vertical;
            "
          ></textarea>
          <div class="button-group" style="margin-top:auto; display:flex; gap:0.5rem;">
            <!-- This POSTs feedback=OK ‚Üí seeds drafts & redirects server-side -->
            <button
              type="submit"
              name="feedback"
              value="OK"
              style="
                background:#28a745;
                color:#fff;
                padding:0.6rem 1.2rem;
                border:none;
                border-radius:4px;
                cursor:pointer;
              "
            >
              Looks Good, Next
            </button>
            <!-- This POSTs feedback=<user text> ‚Üí refines outline in place -->
            <button
              type="submit"
              value="apply"
              style="
                background:#007bff;
                color:#fff;
                padding:0.6rem 1.2rem;
                border:none;
                border-radius:4px;
                cursor:pointer;
              "
            >
              Apply Feedback
            </button>
          </div>
        </form>
      </section>
    </main>
  </div>

  {# Hide the global footer #}
  <style>footer { display: none !important; }</style>
{% endblock %}

{% block extra_scripts %}
<script>
document.addEventListener("DOMContentLoaded", () => {
  const outlineId = "{{ outline_id }}";
  const loader    = document.getElementById("loader-section");
  const loaderText= document.getElementById("loader-text");
  const section   = document.getElementById("outline-section");
  const list      = document.getElementById("outline-content");
  const history   = document.getElementById("feedback-history");
  const form      = document.getElementById("feedback-form");
  const textarea  = document.getElementById("feedback");
  const looksGood = document.getElementById("looks-good");

  async function fetchOutline(feedbackText = null) {
    loader.style.display  = "flex";
    section.style.display = "none";
    loaderText.textContent = feedbackText
      ? "Refining your outline‚Ä¶"
      : "Generating your outline‚Ä¶";

    const resp = await fetch(`/api/outline/${outlineId}/`, {
      method: 'POST',
      headers: {
        'X-CSRFToken': '{{ csrf_token }}',
        'Content-Type': 'application/json'
      },
      body: feedbackText
        ? JSON.stringify({ feedback: feedbackText })
        : null
    });
    if (!resp.ok) throw new Error(resp.statusText);
    const data = await resp.json();

    list.innerHTML = "";
    (data.outline_json.sections || []).forEach(sec => {
      const li = document.createElement("li");
      li.innerHTML = `
        <h3 style="margin:0 0 0.5rem; font-size:1rem; font-weight:600;">
          ${sec.title}
        </h3>
        <p style="margin:0 0 0.8rem; font-size:0.9rem; line-height:1.4;">
          ${sec.description}
        </p>`;
      list.appendChild(li);
    });

    loader.style.display  = "none";
    section.style.display = "flex";

    const entry = document.createElement("li");
    entry.textContent = feedbackText
      ? `‚úî Applied feedback: "${feedbackText}"`
      : "‚úî Outline ready for review.";
    history.appendChild(entry);
  }

  // initial load
  fetchOutline().catch(err => {
    loader.innerHTML = `<p style="color:#c00;">‚ùå Something went wrong.</p>`;
    console.error(err);
  });

  // single submit listener handles both buttons:
  form.addEventListener("submit", async e => {
    // 1) If "Looks Good, Next" was clicked, let the form submit normally:
    if (e.submitter && e.submitter.id === "looks-good") {
      // do nothing here ‚Üí default POST to /blog/outline/<id>/ with feedback=OK
      return;
    }

    // 2) Otherwise, it's "Apply Feedback": intercept, refine in-place
    e.preventDefault();
    const fb = textarea.value.trim();
    if (!fb) return;
    textarea.value = "";
    const note = document.createElement("li");
    note.textContent = `‚úèÔ∏è Feedback: ${fb}`;
    history.appendChild(note);
    await fetchOutline(fb).catch(err => {
      console.error(err);
      loader.innerHTML += `<p style="color:#c00;">‚ùå Retry feedback.</p>`;
    });
  });
});
</script>
{% endblock %}

