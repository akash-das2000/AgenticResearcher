{% extends "base.html" %}
{% load static %}

{% block content %}
  <link rel="stylesheet" href="{% static 'css/progress.css' %}">

  <div style="position:fixed; top:81px; bottom:0; left:0; right:0; display:grid; grid-template-columns:20% 1fr; overflow:hidden;">
    <!-- Sidebar: Feedback History -->
    <aside style="background:#f4f4f4; border-right:1px solid #ccc; padding:1rem; overflow-y:auto;">
      <h3>Feedback History</h3>
      <ul id="feedback-history" style="list-style:none; padding:0; margin:0;">
        <li>ðŸ”„ Generating your blog outlineâ€¦</li>
      </ul>
    </aside>

    <!-- Main: Outline & Form -->
    <main class="main-content" style="display:flex; flex-direction:column; overflow:hidden; padding:1rem; box-sizing:border-box;">
      <!-- Step Tracker -->
      <div class="step-tracker" style="margin-bottom:1rem;">
        <a href="{% url 'outline_refine' outline_id=outline_id %}" class="step active">1. Outline</a>
        <a href="{% url 'section_write' outline_id=outline_id %}" class="step disabled">2. Draft</a>
        <a href="{% url 'blog_meta'    outline_id=outline_id %}" class="step disabled">3. Format</a>
        <a href="{% url 'blog_finish'  outline_id=outline_id %}" class="step disabled">4. Finalize</a>
      </div>

      <!-- Loader -->
      <div id="loader-section" style="flex:1; display:flex; flex-direction:column; justify-content:center; align-items:center; overflow:hidden;">
        <div class="spinner"></div>
        <p id="loader-text" style="margin-top:0.5rem; font-size:0.9rem;">Generating your outlineâ€¦ Please wait.</p>
      </div>

      <!-- Outline + Feedback -->
      <section id="outline-section" style="display:none; flex:1; flex-direction:column; overflow:hidden;">
        <h2 style="margin:0 0 0.5rem;">Hereâ€™s Your Blog Outline</h2>
        <p style="margin:0 0 1rem; color:#555;">Review the structure below and let me know any tweaks.</p>
        <ul id="outline-content" class="outline-list"></ul>
        <form id="feedback-form" method="post" style="display:flex; flex-direction:column;">
          {% csrf_token %}
          <textarea id="feedback" name="feedback" rows="3" placeholder="Any adjustments or notes?"></textarea>
          <div class="button-group">
            <button id="looks-good" type="submit" name="feedback" value="OK">Looks Good, Next</button>
            <button type="submit">Apply Feedback</button>
          </div>
        </form>
      </section>
    </main>
  </div>

  <style>
    footer { display:none!important; }
    .step.disabled { pointer-events:none; opacity:0.5; }
    #feedback-history li { cursor:pointer; padding:0.2rem 0; }
    #feedback-history li:hover { text-decoration:underline; }
    #feedback-history li.finalized { color:#28a745; font-weight:bold; }
  </style>
{% endblock %}

{% block extra_scripts %}
<script>
document.addEventListener("DOMContentLoaded", () => {
  const outlineId  = "{{ outline_id }}";
  const storageKey = `outlineCache_${outlineId}`;
  const loader     = document.getElementById("loader-section");
  const loaderText = document.getElementById("loader-text");
  const section    = document.getElementById("outline-section");
  const list       = document.getElementById("outline-content");
  const historyEl  = document.getElementById("feedback-history");
  const form       = document.getElementById("feedback-form");
  const textarea   = document.getElementById("feedback");
  const draftLink  = document.querySelector('.step-tracker a[href*="section"]');

  // load cache
  let cache = JSON.parse(localStorage.getItem(storageKey) || "[]");
  historyEl.innerHTML = "";
  cache.forEach((snap, i) => {
    const li = document.createElement("li");
    li.textContent   = snap.label;
    if (snap.finalized) li.classList.add("finalized");
    li.addEventListener("click", () => render(snap.sections));
    historyEl.appendChild(li);
  });

  function save() {
    localStorage.setItem(storageKey, JSON.stringify(cache));
  }
  function record(label, sections, finalized=false) {
    cache.push({label, sections, finalized});
    save();
    const li = document.createElement("li");
    li.textContent = label;
    if (finalized) li.classList.add("finalized");
    li.addEventListener("click", () => render(sections));
    historyEl.appendChild(li);
    if (finalized) draftLink.classList.remove("disabled");
  }
  function render(sections) {
    list.innerHTML = "";
    sections.forEach(sec => {
      const li = document.createElement("li");
      li.innerHTML = `<h3 class="outline-title">${sec.title}</h3><p class="outline-desc">${sec.description}</p>`;
      list.appendChild(li);
    });
    loader.style.display  = 'none';
    section.style.display = 'flex';
  }

  async function fetchOutline(feedback=null) {
    loader.style.display  = 'flex';
    section.style.display = 'none';
    loaderText.textContent = feedback ? 'Refining your outlineâ€¦' : 'Generating your outlineâ€¦';
    const resp = await fetch(`/api/outline/${outlineId}/`, {
      method:'POST',
      headers: {
        'X-CSRFToken':'{{ csrf_token }}',
        'Content-Type':'application/json'
      },
      body: feedback ? JSON.stringify({feedback}) : null
    });
    if (!resp.ok) throw new Error(resp.statusText);
    const data = await resp.json();
    render(data.outline_json.sections);
    if (feedback) record(`âœï¸ ${feedback}`, data.outline_json.sections);
    else         record('âœ” Outline ready for review.', data.outline_json.sections);
  }

  // initial load
  fetchOutline();

  form.addEventListener("submit", e => {
    if (e.submitter.id==='looks-good') {
      record('âœ” Finalized outline.', cache[cache.length-1].sections, true);
      return; // redirect to draft
    }
    e.preventDefault();
    const fb = textarea.value.trim();
    if (!fb) return;
    textarea.value = '';
    fetchOutline(fb);
  });
});
</script>
{% endblock %}
