{% extends "base.html" %}
{% load static %}

{% block content %}
<link rel="stylesheet" href="{% static 'css/progress.css' %}">

<div class="blog-container">
  <!-- Sidebar -->
  <aside class="sidebar">
    <h3>Feedback History</h3>
    <ul id="feedback-history">
      <li>üîÑ Generating your blog outline...</li>
    </ul>
  </aside>

  <!-- Main Content Area -->
  <main class="main-content">
    <!-- Step Tracker -->
    <div class="step-tracker">
      <div class="step completed">1. Outline</div>
      <div class="step">2. Refine</div>
      <div class="step">3. Draft</div>
      <div class="step">4. Format</div>
      <div class="step">5. Finish</div>
    </div>

    <!-- Loader -->
    <div id="loader-section">
      <div class="spinner"></div>
      <p>Generating your outline. Please wait...</p>
    </div>

    <!-- Outline Content -->
    <div id="outline-section" style="display: none;">
      <h2>Step 1: Refine Your Blog Outline</h2>
      <div id="outline-content"></div>

      <form method="post" id="feedback-form">
        {% csrf_token %}
        <label for="feedback">What would you like tweaked?</label>
        <textarea name="feedback" id="feedback" rows="3" placeholder="Enter feedback here..."></textarea>
        <div class="button-group">
          <button type="button" id="looks-good">Looks Good</button>
          <button type="submit">Apply Feedback</button>
        </div>
      </form>
    </div>
  </main>
</div>

<script>
  document.addEventListener("DOMContentLoaded", function () {
    const pk = "{{ outline_id|default:1 }}"; // safer handling of outline_id

    // Trigger outline API on load
    fetch(`/api/outline/${pk}/`, {
      method: 'POST',
      headers: {
        'X-CSRFToken': '{{ csrf_token }}'
      }
    })
    .then(response => {
      if (!response.ok) throw new Error("API failed with status " + response.status);
      return response.json();
    })
    .then(data => {
      // Hide loader, show content
      document.getElementById("loader-section").style.display = "none";
      document.getElementById("outline-section").style.display = "block";

      // Render outline
      document.getElementById("outline-content").innerText = JSON.stringify(data.outline_json, null, 2);

      // Update sidebar
      const history = document.getElementById("feedback-history");
      const li = document.createElement("li");
      li.textContent = "‚úî Outline generated successfully.";
      history.appendChild(li);

      // Mark step 1 complete
      document.querySelector(".step-tracker .step").classList.add("completed");
    })
    .catch(err => {
      console.error("Error generating outline:", err);
      const loader = document.getElementById("loader-section");
      loader.querySelector(".spinner").style.display = "none";
      loader.innerHTML += `<p style="color:red;">‚ùå Failed to generate outline. Please try again later.</p>`;
    });

    // Handle feedback form
    document.getElementById("feedback-form").addEventListener("submit", function (e) {
      e.preventDefault();
      const feedbackText = document.getElementById("feedback").value;
      if (feedbackText.trim() !== "") {
        const history = document.getElementById("feedback-history");
        const li = document.createElement("li");
        li.textContent = `‚úèÔ∏è User feedback: ${feedbackText}`;
        history.appendChild(li);
        document.getElementById("feedback").value = '';
      }
    });
  });
</script>
{% endblock %}
