{% extends "base.html" %}
{% load static %}

{% block content %}
<link rel="stylesheet" href="{% static 'css/progress.css' %}">

<div class="blog-container">
  <!-- Sidebar -->
  <aside class="sidebar">
    <h3>Feedback History</h3>
    <ul id="feedback-history">
      <li>🔄 Generating your blog outline…</li>
    </ul>
  </aside>

  <!-- Main Content -->
  <main class="main-content">
    <!-- Phase Tracker -->
    <div class="step-tracker">
      <div class="step completed">1. Outline</div>
      <div class="step">2. Draft</div>
      <div class="step">3. Format</div>
      <div class="step">4. Finalize</div>
    </div>

    <!-- Loader -->
    <div id="loader-section">
      <div class="spinner"></div>
      <p>Generating your outline. Please wait…</p>
    </div>

    <!-- Outline Display -->
    <section id="outline-section" style="display: none;">
      <h2>Here’s Your Blog Outline</h2>
      <p class="subheading">Review the structure below and let me know any tweaks.</p>
      <ol id="outline-content" class="outline-list"></ol>

      <form method="post" id="feedback-form">
        {% csrf_token %}
        <label for="feedback">Any adjustments or notes?</label>
        <textarea name="feedback" id="feedback" rows="3" placeholder="e.g. “Combine sections 2 and 3”"></textarea>
        <div class="button-group">
          <button type="button" id="looks-good">Looks Good, Next</button>
          <button type="submit">Apply Feedback</button>
        </div>
      </form>
    </section>
  </main>
</div>

<script>
document.addEventListener("DOMContentLoaded", () => {
  const outlineId = "{{ outline.id }}";
  const loader    = document.getElementById("loader-section");
  const section   = document.getElementById("outline-section");
  const list      = document.getElementById("outline-content");
  const history   = document.getElementById("feedback-history");

  // Kick off the outline-generation API
  fetch(`/api/outline/${outlineId}/`, {
    method: 'POST',
    headers: { 'X-CSRFToken': '{{ csrf_token }}' }
  })
  .then(res => {
    if (!res.ok) throw new Error(res.status);
    return res.json();
  })
  .then(data => {
    // Hide loader, show outline
    loader.style.display  = "none";
    section.style.display = "block";

    // Build a clean list of sections (let <ol> number them)
    const sections = data.outline_json.sections || [];
    sections.forEach(sec => {
      const item = document.createElement("li");
      item.classList.add("outline-item");

      const title = document.createElement("h3");
      title.textContent = sec.title;
      title.classList.add("outline-title");

      const desc = document.createElement("p");
      desc.textContent = sec.description;
      desc.classList.add("outline-desc");

      item.appendChild(title);
      item.appendChild(desc);
      list.appendChild(item);
    });

    // Record in sidebar
    const ok = document.createElement("li");
    ok.textContent = "✔ Outline ready for review.";
    history.appendChild(ok);
  })
  .catch(err => {
    console.error(err);
    loader.querySelector(".spinner").style.display = "none";
    loader.innerHTML += `<p class="error-msg">❌ Failed to generate outline. Please try again later.</p>`;
  });

  // Feedback form
  document.getElementById("feedback-form").addEventListener("submit", e => {
    e.preventDefault();
    const txt = document.getElementById("feedback").value.trim();
    if (!txt) return;
    const li = document.createElement("li");
    li.textContent = `✏️ Feedback: ${txt}`;
    history.appendChild(li);
    document.getElementById("feedback").value = '';
  });

  // “Looks Good” button → Draft step
  document.getElementById("looks-good").addEventListener("click", () => {
    window.location.href = `{% url 'section_write' outline_id=outline.id %}`;
  });
});
</script>
{% endblock %}
