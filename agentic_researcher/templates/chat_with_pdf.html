{# agentic_researcher/templates/chat_with_pdf.html #}
{% extends "base.html" %}
{% load static %}

{# 1. Pull in our new chat CSS #}
{% block extra_styles %}
<link rel="stylesheet" href="{% static 'css/chat_with_pdf.css' %}">
{% endblock %}

{# 2. Suppress the site footer #}
{% block footer %}{% endblock %}

{% block content %}
  <div class="chat-container">
    <!-- LEFT: history sidebar -->
    <aside id="history-panel">
      <div id="history-header">
        <h3>Chat History</h3>
        <button id="toggle-history">⮜</button>
      </div>
      <ul id="chat-history">
        <!-- populated by JS -->
      </ul>
    </aside>

    <!-- RIGHT: chat area -->
    <section class="main-content">
      <div class="chat-header">
        Chat with PDF: <strong>{{ pdf_title }}</strong>
      </div>
      <div id="chat-window">
        <!-- bubbles go here -->
      </div>
      <form id="chat-form">
        {% csrf_token %}
        <input
          type="text"
          id="chat-input"
          placeholder="Ask something about this PDF…"
          autocomplete="off"
        />
        <button type="submit" id="send-btn">Send</button>
      </form>
    </section>
  </div>
{% endblock %}

{% block extra_scripts %}
<script>
document.addEventListener("DOMContentLoaded", () => {
  const pdfId      = {{ pdf_id }};
  const apiUrl     = `/api/chat/pdf/${pdfId}/`;
  const historyKey = `chatHistory_${pdfId}`;

  let history = JSON.parse(localStorage.getItem(historyKey) || "[]");

  const historyPanel = document.getElementById("history-panel");
  const toggleBtn    = document.getElementById("toggle-history");
  const historyList  = document.getElementById("chat-history");
  const chatWindow   = document.getElementById("chat-window");
  const chatForm     = document.getElementById("chat-form");
  const chatInput    = document.getElementById("chat-input");

  function renderHistory() {
    historyList.innerHTML = "";
    history.forEach((turn, idx) => {
      const li = document.createElement("li");
      li.textContent = (turn.role === "user" ? "You: " : "AI: ")
        + turn.content.slice(0, 30) + "…";
      li.addEventListener("click", () => renderChatUpTo(idx));
      historyList.appendChild(li);
    });
  }

  function renderChatUpTo(idx = history.length - 1) {
    chatWindow.innerHTML = "";
    history.slice(0, idx + 1).forEach(turn => {
      const bubble = document.createElement("div");
      bubble.className = `bubble ${turn.role}`;
      bubble.textContent = turn.content;
      chatWindow.appendChild(bubble);
    });
    chatWindow.scrollTop = chatWindow.scrollHeight;
  }

  renderHistory();
  renderChatUpTo();

  toggleBtn.addEventListener("click", () =>
    historyPanel.classList.toggle("collapsed")
  );

  chatForm.addEventListener("submit", async e => {
    e.preventDefault();
    const q = chatInput.value.trim();
    if (!q) return;
    history.push({ role: "user", content: q });
    localStorage.setItem(historyKey, JSON.stringify(history));
    renderHistory(); renderChatUpTo();
    chatInput.value = "";

    const res = await fetch(apiUrl, {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "X-CSRFToken": "{{ csrf_token }}",
      },
      body: JSON.stringify({ question: q })
    });
    const { answer } = await res.json();
    history.push({ role: "ai", content: answer });
    localStorage.setItem(historyKey, JSON.stringify(history));
    renderHistory(); renderChatUpTo();
  });
});
</script>
{% endblock %}
