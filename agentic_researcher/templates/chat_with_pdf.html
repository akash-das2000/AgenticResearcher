{# agentic_researcher/templates/chat_with_pdf.html #}
{% extends "base.html" %}
{% load static %}

{% block content %}
  <style>
    /* full-viewport two-column grid under the navbar */
    .chat-container {
      position: fixed;
      top: 81px;  /* adjust if your navbar height is different */
      bottom: 0;
      left: 0;
      right: 0;
      display: grid;
      grid-template-columns: 20% 1fr;
      overflow: hidden;
    }
    /* Left history panel */
    #history-panel {
      background: #f4f4f4;
      border-right: 1px solid #ccc;
      padding: 1rem;
      box-sizing: border-box;
      display: flex;
      flex-direction: column;
    }
    #history-panel.collapsed {
      width: 0;
      padding: 0;
      border: none;
      overflow: hidden;
    }
    #history-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    #history-header h3 {
      margin: 0;
      font-size: 1.1rem;
    }
    #toggle-history {
      background: none;
      border: none;
      cursor: pointer;
      font-size: 1.2rem;
      transform: rotate(0deg);
      transition: transform 0.2s;
    }
    #history-panel.collapsed #toggle-history {
      transform: rotate(180deg);
    }
    #chat-history {
      list-style: none;
      padding: 0;
      margin: 1rem 0 0;
      overflow-y: auto;
      flex: 1;
    }
    #chat-history li {
      padding: 0.3rem 0;
      cursor: pointer;
      border-bottom: 1px solid #ddd;
    }
    #chat-history li:hover {
      background: #e9e9e9;
    }

    /* Right chat panel */
    main.chat-main {
      display: flex;
      flex-direction: column;
      padding: 1rem;
      box-sizing: border-box;
    }
    .chat-header {
      font-size: 1.2rem;
      margin-bottom: 0.5rem;
      font-weight: 600;
    }
    #chat-window {
      flex: 1;
      overflow-y: auto;
      padding-right: 1rem;
    }
    .bubble {
      max-width: 70%;
      margin: 0.5rem 0;
      padding: 0.6rem 0.8rem;
      border-radius: 12px;
      line-height: 1.4;
      word-wrap: break-word;
    }
    .bubble.user {
      background: #007bff;
      color: #fff;
      align-self: flex-end;
    }
    .bubble.ai {
      background: #e2e2e2;
      color: #000;
      align-self: flex-start;
    }
    /* Input area */
    #chat-form {
      display: flex;
      gap: 0.5rem;
      margin-top: 0.5rem;
    }
    #chat-input {
      flex: 1;
      padding: 0.6rem;
      border: 1px solid #ccc;
      border-radius: 4px;
      font-size: 1rem;
    }
    #send-btn {
      padding: 0.6rem 1.2rem;
      background: #28a745;
      color: #fff;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
  </style>

  <div class="chat-container">
    <!-- Left: Chat History -->
    <aside id="history-panel">
      <div id="history-header">
        <h3>Chat History</h3>
        <button id="toggle-history">⮜</button>
      </div>
      <ul id="chat-history">
        {{-- populated by JS --}}
      </ul>
    </aside>

    <!-- Right: Chat Interface -->
    <main class="chat-main">
      <div class="chat-header">Chat with PDF: <strong>{{ pdf_title }}</strong></div>
      <div id="chat-window">
        {{-- chat bubbles go here --}}
      </div>
      <form id="chat-form">
        {% csrf_token %}
        <input
          type="text"
          id="chat-input"
          placeholder="Ask something about this PDF…"
          autocomplete="off"
        />
        <button type="submit" id="send-btn">Send</button>
      </form>
    </main>
  </div>
{% endblock %}

{% block extra_scripts %}
<script>
document.addEventListener("DOMContentLoaded", () => {
  const pdfId      = {{ pdf_id }};
  const apiUrl     = `/api/chat/pdf/${pdfId}/`;
  const historyKey = `chatHistory_${pdfId}`;

  const historyPanel  = document.getElementById("history-panel");
  const toggleBtn     = document.getElementById("toggle-history");
  const historyList   = document.getElementById("chat-history");
  const chatWindow    = document.getElementById("chat-window");
  const chatForm      = document.getElementById("chat-form");
  const chatInput     = document.getElementById("chat-input");

  // Load history from localStorage
  let history = JSON.parse(localStorage.getItem(historyKey) || "[]");
  function renderHistory() {
    historyList.innerHTML = "";
    history.forEach((turn, idx) => {
      const li = document.createElement("li");
      li.textContent = turn.role === "user"
        ? `You: ${turn.content.slice(0,30)}…`
        : `AI: ${turn.content.slice(0,30)}…`;
      li.addEventListener("click", () => renderChatUpTo(idx));
      historyList.appendChild(li);
    });
  }

  // Render chat window up to a certain turn
  function renderChatUpTo(index = history.length - 1) {
    chatWindow.innerHTML = "";
    for (let i = 0; i <= index; i++) {
      const turn = history[i];
      const div  = document.createElement("div");
      div.classList.add("bubble", turn.role);
      div.textContent = turn.content;
      chatWindow.appendChild(div);
    }
    chatWindow.scrollTop = chatWindow.scrollHeight;
  }

  // Initial render
  renderHistory();
  renderChatUpTo();

  // Toggle history panel
  toggleBtn.addEventListener("click", () =>
    historyPanel.classList.toggle("collapsed")
  );

  // Handle form submit
  chatForm.addEventListener("submit", async e => {
    e.preventDefault();
    const question = chatInput.value.trim();
    if (!question) return;

    // 1. Append user bubble & save
    history.push({ role: "user", content: question });
    localStorage.setItem(historyKey, JSON.stringify(history));
    renderHistory();
    renderChatUpTo();

    chatInput.value = "";  // clear

    // 2. Call backend
    const resp = await fetch(apiUrl, {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "X-CSRFToken": "{{ csrf_token }}",
      },
      body: JSON.stringify({ question })
    });
    const { answer } = await resp.json();

    // 3. Append AI bubble & save
    history.push({ role: "ai", content: answer });
    localStorage.setItem(historyKey, JSON.stringify(history));
    renderHistory();
    renderChatUpTo();
  });
});
</script>
{% endblock %}
