{% extends "base.html" %}
{% load static %}

{% block extra_styles %}
<link rel="stylesheet" href="{% static 'css/chat.css' %}">
{% endblock %}

{% block footer %}{% endblock %}

{% block content %}
<div class="chat-container" id="chat-container">
  <!-- LEFT: History panel -->
  <aside id="history-panel">
    <div id="history-header">
      <h3>Chat History</h3>
    </div>
    <ul id="chat-history">
      <!-- only user questions will be listed -->
    </ul>
  </aside>

  <!-- TOGGLE BUTTON -->
  <button id="toggle-history" class="history-toggle">⮜</button>

  <!-- RIGHT: Chat area -->
  <section class="main-content">
    <div class="chat-header">
      Chat with PDF: <strong>{{ pdf_title }}</strong>
    </div>
    <div id="chat-window">
      <!-- bubbles go here -->
    </div>
    <form id="chat-form">
      {% csrf_token %}
      <input
        id="chat-input"
        type="text"
        placeholder="Ask something about this PDF…"
        autocomplete="off"
      />
      <button id="send-btn" type="submit">Send</button>
    </form>
  </section>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
document.addEventListener("DOMContentLoaded", () => {
  const pdfId      = {{ pdf_id }};
  const apiUrl     = `/api/chat/pdf/${pdfId}/`;
  const historyKey = `chatHistory_${pdfId}`;

  // full turn history, including ai responses
  let fullHistory = JSON.parse(localStorage.getItem(historyKey) || "[]");
  // indices of user messages in fullHistory
  let userIndices = fullHistory
    .map((h, i) => h.role === "user" ? i : -1)
    .filter(i => i >= 0);

  const container    = document.getElementById("chat-container");
  const panel        = document.getElementById("history-panel");
  const toggleBtn    = document.getElementById("toggle-history");
  const historyList  = document.getElementById("chat-history");
  const chatWindow   = document.getElementById("chat-window");
  const chatForm     = document.getElementById("chat-form");
  const chatInput    = document.getElementById("chat-input");

  function saveHistory() {
    localStorage.setItem(historyKey, JSON.stringify(fullHistory));
    userIndices = fullHistory
      .map((h, i) => h.role === "user" ? i : -1)
      .filter(i => i >= 0);
  }

  function renderHistory() {
    historyList.innerHTML = "";
    userIndices.forEach((fullIdx, idx) => {
      const turn = fullHistory[fullIdx];
      const li = document.createElement("li");
      li.textContent = turn.content.slice(0, 30) + "…";
      li.addEventListener("click", () => renderChatUpTo(fullIdx));
      historyList.appendChild(li);
    });
  }

  function renderChatUpTo(fullIdx = fullHistory.length - 1) {
    chatWindow.innerHTML = "";
    for (let i = 0; i <= fullIdx; i++) {
      const turn = fullHistory[i];
      const bubble = document.createElement("div");
      bubble.classList.add("bubble", turn.role);
      bubble.textContent = turn.content;
      chatWindow.appendChild(bubble);
    }
    chatWindow.scrollTop = chatWindow.scrollHeight;
  }

  // initial render
  renderHistory();
  renderChatUpTo();

  // toggle panel
  toggleBtn.addEventListener("click", () => {
    container.classList.toggle("collapsed");
  });

  // submit new question
  chatForm.addEventListener("submit", async e => {
    e.preventDefault();
    const q = chatInput.value.trim();
    if (!q) return;

    // add user turn
    fullHistory.push({ role: "user", content: q });
    saveHistory();
    renderHistory();
    renderChatUpTo();
    chatInput.value = "";

    // call backend
    const resp = await fetch(apiUrl, {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "X-CSRFToken": "{{ csrf_token }}",
      },
      body: JSON.stringify({ question: q }),
    });
    const data = await resp.json();
    const answer = data.answer || data.error || "❌ Error";

    // add AI turn
    fullHistory.push({ role: "ai", content: answer });
    saveHistory();
    renderHistory();
    renderChatUpTo();
  });
});
</script>
{% endblock %}
