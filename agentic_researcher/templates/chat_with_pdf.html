{% extends "base.html" %}
{% load static %}

{# 1. Load the chat-specific stylesheet #}
{% block extra_styles %}
<link rel="stylesheet" href="{% static 'css/chat.css' %}">
{% endblock %}

{# 2. Suppress the global footer on this page #}
{% block footer %}{% endblock %}

{% block content %}
<div class="chat-container">
  <!-- LEFT: chat history sidebar -->
  <aside id="history-panel">
    <div id="history-header">
      <h3>Chat History</h3>
      <button id="toggle-history">⮜</button>
    </div>
    <ul id="chat-history">
      <!-- populated by JS -->
    </ul>
  </aside>

  <!-- RIGHT: active chat panel -->
  <section class="main-content">
    <div class="chat-header">
      Chat with PDF: <strong>{{ pdf_title }}</strong>
    </div>
    <div id="chat-window">
      <!-- chat bubbles appear here -->
    </div>
    <form id="chat-form">
      {% csrf_token %}
      <input
        id="chat-input"
        type="text"
        placeholder="Ask something about this PDF…"
        autocomplete="off"
      />
      <button id="send-btn" type="submit">Send</button>
    </form>
  </section>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
document.addEventListener("DOMContentLoaded", () => {
  const pdfId      = {{ pdf_id }};
  const apiUrl     = `/api/chat/pdf/${pdfId}/`;
  const historyKey = `chatHistory_${pdfId}`;

  let history = JSON.parse(localStorage.getItem(historyKey) || "[]");

  const panel  = document.getElementById("history-panel");
  const toggle = document.getElementById("toggle-history");
  const list   = document.getElementById("chat-history");
  const win    = document.getElementById("chat-window");
  const form   = document.getElementById("chat-form");
  const input  = document.getElementById("chat-input");

  function renderHistory() {
    list.innerHTML = "";
    history.forEach((t,i) => {
      const li = document.createElement("li");
      li.textContent = (t.role==="user"?"You: ":"AI: ") + t.content.slice(0,30) + "…";
      li.onclick = () => renderUpTo(i);
      list.appendChild(li);
    });
  }

  function renderUpTo(idx = history.length-1) {
    win.innerHTML = "";
    history.slice(0,idx+1).forEach(t => {
      const b = document.createElement("div");
      b.className = `bubble ${t.role}`;
      b.textContent = t.content;
      win.appendChild(b);
    });
    win.scrollTop = win.scrollHeight;
  }

  renderHistory();
  renderUpTo();

  toggle.onclick = () => panel.classList.toggle("collapsed");

  form.addEventListener("submit", async e => {
    e.preventDefault();
    const q = input.value.trim();
    if (!q) return;
    history.push({role:"user",content:q});
    localStorage.setItem(historyKey, JSON.stringify(history));
    renderHistory(); renderUpTo();
    input.value = "";

    const res = await fetch(apiUrl, {
      method: "POST",
      headers: {
        "Content-Type":"application/json",
        "X-CSRFToken":"{{ csrf_token }}",
      },
      body: JSON.stringify({question:q})
    });
    const { answer } = await res.json();
    history.push({role:"ai",content:answer});
    localStorage.setItem(historyKey, JSON.stringify(history));
    renderHistory(); renderUpTo();
  });
});
</script>
{% endblock %}
