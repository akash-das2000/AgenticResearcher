{% extends 'base.html' %}

{% block content %}
<div class="split-container">
    <div class="pdf-viewer" id="pdfViewer">
        <p class="placeholder-text">üìñ PDF preview will appear here after upload.</p>
    </div>
    <div class="upload-container">
        <div class="dropzone" id="dropzone">
            <p>üìÇ Drag & drop your PDF here <br> or</p>
            <form id="uploadForm" onsubmit="return false;">
                {% csrf_token %}
                <!-- Visible file input instead of hidden for better compatibility -->
                <input type="file" id="pdfFile" name="pdf_file" accept="application/pdf" style="display:none;">
                <button type="button" id="selectFileBtn">Choose a PDF</button>
                <button type="submit" id="uploadBtn" disabled>Upload PDF</button>
            </form>
        </div>
        <div id="uploadStatus"></div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const dropzone = document.getElementById('dropzone');
    const fileInput = document.getElementById('pdfFile');
    const selectFileBtn = document.getElementById('selectFileBtn');
    const uploadBtn = document.getElementById('uploadBtn');
    const uploadForm = document.getElementById('uploadForm');
    const uploadStatus = document.getElementById('uploadStatus');
    const pdfViewer = document.getElementById('pdfViewer');
    let selectedFile = null;

    // ‚úÖ Open file picker when "Choose a PDF" clicked
    selectFileBtn.addEventListener('click', function() {
        console.log("Choose PDF button clicked"); // Debug log
        fileInput.click();
    });

    // ‚úÖ Handle file selection from file picker
    fileInput.addEventListener('change', function() {
        if (fileInput.files.length > 0) {
            selectedFile = fileInput.files[0];
            uploadBtn.disabled = false;
            uploadStatus.innerHTML = `Selected: <strong>${selectedFile.name}</strong>`;
        }
    });

    // ‚úÖ Handle drag & drop
    dropzone.addEventListener('dragover', function(e) {
        e.preventDefault();
        dropzone.classList.add('dragover');
    });

    dropzone.addEventListener('dragleave', function() {
        dropzone.classList.remove('dragover');
    });

    dropzone.addEventListener('drop', function(e) {
        e.preventDefault();
        dropzone.classList.remove('dragover');
        if (e.dataTransfer.files.length > 0) {
            selectedFile = e.dataTransfer.files[0];
            // Manually set fileInput so formData picks it up
            const dataTransfer = new DataTransfer();
            dataTransfer.items.add(selectedFile);
            fileInput.files = dataTransfer.files;

            uploadBtn.disabled = false;
            uploadStatus.innerHTML = `Selected: <strong>${selectedFile.name}</strong>`;
        }
    });

    // ‚úÖ Handle form submit (upload)
    uploadForm.addEventListener('submit', function(e) {
        e.preventDefault();
        if (!selectedFile) {
            uploadStatus.innerHTML = `<span class="error">‚ö†Ô∏è No file selected.</span>`;
            return;
        }

        uploadStatus.innerHTML = "‚è≥ Uploading...";
        uploadBtn.disabled = true;

        const formData = new FormData();
        formData.append('pdf_file', selectedFile);

        fetch('/api/upload/', {
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.id && data.url) {
                uploadStatus.innerHTML = `<span class="success">‚úÖ Upload successful!</span> PDF ID: ${data.id}`;
                renderPDF(data.url);
            } else {
                uploadStatus.innerHTML = `<span class="error">‚ùå Error: ${JSON.stringify(data)}</span>`;
            }
            uploadBtn.disabled = false;
        })
        .catch(error => {
            console.error("Upload error:", error);
            uploadStatus.innerHTML = `<span class="error">‚ùå Upload failed: ${error}</span>`;
            uploadBtn.disabled = false;
        });
    });

    // ‚úÖ Render PDF using PDF.js
    function renderPDF(pdfUrl) {
        console.log("Rendering PDF:", pdfUrl);
        const loadingTask = pdfjsLib.getDocument(pdfUrl);
        loadingTask.promise.then(pdf => {
            pdfViewer.innerHTML = ''; // Clear placeholder
            for (let pageNum = 1; pageNum <= pdf.numPages; pageNum++) {
                pdf.getPage(pageNum).then(page => {
                    const viewport = page.getViewport({ scale: 1.0 });
                    const canvas = document.createElement('canvas');
                    const context = canvas.getContext('2d');
                    canvas.height = viewport.height;
                    canvas.width = viewport.width;
                    pdfViewer.appendChild(canvas);

                    const renderContext = {
                        canvasContext: context,
                        viewport: viewport
                    };
                    page.render(renderContext);
                });
            }
        }).catch(error => {
            console.error("PDF render error:", error);
            pdfViewer.innerHTML = `<span class="error">‚ùå Failed to load PDF: ${error.message}</span>`;
        });
    }
});
</script>
{% endblock %}
