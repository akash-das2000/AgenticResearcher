{% extends 'base.html' %}

{% block content %}
<div class="split-container">
    <div class="pdf-viewer" id="pdfViewer">
        <p class="placeholder-text">üìñ PDF preview will appear here after upload.</p>
    </div>
    <div class="upload-container">
        <div class="dropzone" id="dropzone">
            <p>üìÇ Drag & drop your PDF here <br> or</p>
            <form id="uploadForm">
                {% csrf_token %}
                <input type="file" id="pdfFile" name="pdf_file" accept="application/pdf" hidden>
                <button type="button" id="selectFileBtn">Choose a PDF</button>
                <button type="submit" id="uploadBtn" disabled>Upload PDF</button>
            </form>
        </div>
        <div id="uploadStatus"></div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const dropzone = document.getElementById('dropzone');
    const fileInput = document.getElementById('pdfFile');
    const selectFileBtn = document.getElementById('selectFileBtn');
    const uploadBtn = document.getElementById('uploadBtn');
    const uploadForm = document.getElementById('uploadForm');
    const uploadStatus = document.getElementById('uploadStatus');
    const pdfViewer = document.getElementById('pdfViewer');
    let selectedFile = null;

    selectFileBtn.addEventListener('click', () => fileInput.click());
    fileInput.addEventListener('change', () => {
        if (fileInput.files.length > 0) {
            selectedFile = fileInput.files[0];
            uploadBtn.disabled = false;
            uploadStatus.innerHTML = `Selected: <strong>${selectedFile.name}</strong>`;
        }
    });

    dropzone.addEventListener('dragover', (e) => {
        e.preventDefault();
        dropzone.classList.add('dragover');
    });

    dropzone.addEventListener('dragleave', () => {
        dropzone.classList.remove('dragover');
    });

    dropzone.addEventListener('drop', (e) => {
        e.preventDefault();
        dropzone.classList.remove('dragover');
        selectedFile = e.dataTransfer.files[0];
        fileInput.files = e.dataTransfer.files;
        uploadBtn.disabled = false;
        uploadStatus.innerHTML = `Selected: <strong>${selectedFile.name}</strong>`;
    });

    uploadForm.addEventListener('submit', function(e) {
        e.preventDefault();
        if (!selectedFile) return;

        uploadStatus.innerHTML = "Uploading...";
        uploadBtn.disabled = true;

        const formData = new FormData();
        formData.append('pdf_file', selectedFile);

        fetch('/api/upload/', {
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.id && data.url) {
                uploadStatus.innerHTML = `<span class="success">‚úÖ Upload successful!</span> PDF ID: ${data.id}`;
                renderPDF(data.url);
            } else {
                uploadStatus.innerHTML = `<span class="error">‚ùå Error: ${JSON.stringify(data)}</span>`;
            }
            uploadBtn.disabled = false;
        })
        .catch(error => {
            uploadStatus.innerHTML = `<span class="error">‚ùå Upload failed: ${error}</span>`;
            uploadBtn.disabled = false;
        });
    });

    function renderPDF(pdfUrl) {
        const loadingTask = pdfjsLib.getDocument(pdfUrl);
        loadingTask.promise.then(pdf => {
            pdfViewer.innerHTML = ''; // Clear placeholder
            for (let pageNum = 1; pageNum <= pdf.numPages; pageNum++) {
                pdf.getPage(pageNum).then(page => {
                    const viewport = page.getViewport({ scale: 1.2 });
                    const canvas = document.createElement('canvas');
                    const context = canvas.getContext('2d');
                    canvas.height = viewport.height;
                    canvas.width = viewport.width;
                    pdfViewer.appendChild(canvas);

                    const renderContext = {
                        canvasContext: context,
                        viewport: viewport
                    };
                    page.render(renderContext);
                });
            }
        }, error => {
            pdfViewer.innerHTML = `<span class="error">‚ùå Failed to load PDF: ${error}</span>`;
        });
    }
});
</script>
{% endblock %}
