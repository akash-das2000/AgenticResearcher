{% extends 'base.html' %}

{% block content %}
<div class="split-container">
    <div class="pdf-viewer" id="pdfViewer">
        <p class="placeholder-text">ğŸ“– PDF preview will appear here after upload.</p>
    </div>
    <div class="upload-container">
        <div class="dropzone" id="dropzone">
            <p>ğŸ“‚ Drag & drop your PDF here <br> or</p>
            <form id="uploadForm" onsubmit="return false;">
                {% csrf_token %}
                <input type="file" id="pdfFile" name="pdf_file" accept="application/pdf" style="display:none;">
                <button type="button" id="selectFileBtn" class="primary-btn">Choose a PDF</button>
                <button type="submit" id="uploadBtn" class="primary-btn" disabled>Upload PDF</button>
            </form>
        </div>
        <div id="uploadStatus"></div>

        <!-- âœ… Post-upload action buttons -->
        <div id="postUploadActions" class="post-upload-actions" style="display: none;">
            <h3>Next Actions</h3>
            <button id="chatBtn" class="action-btn">ğŸ’¬ Chat with PDF</button>
            <button id="blogBtn" class="action-btn">ğŸ“ Make a Blog</button>
            <button id="pptBtn" class="action-btn">ğŸ“Š Make a PPT</button>
            <button id="posterBtn" class="action-btn">ğŸ–¼ï¸ Make a Poster</button>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const dropzone = document.getElementById('dropzone');
    const fileInput = document.getElementById('pdfFile');
    const selectFileBtn = document.getElementById('selectFileBtn');
    const uploadBtn = document.getElementById('uploadBtn');
    const uploadForm = document.getElementById('uploadForm');
    const uploadStatus = document.getElementById('uploadStatus');
    const pdfViewer = document.getElementById('pdfViewer');
    const postUploadActions = document.getElementById('postUploadActions');
    let selectedFile = null;
    let uploadedPdfId = null;

    // Open file picker
    selectFileBtn.addEventListener('click', () => fileInput.click());

    // File selected
    fileInput.addEventListener('change', () => {
        if (fileInput.files.length > 0) {
            selectedFile = fileInput.files[0];
            uploadBtn.disabled = false;
            uploadStatus.innerHTML = `Selected: <strong>${selectedFile.name}</strong>`;
        }
    });

    // Drag and drop
    dropzone.addEventListener('dragover', e => {
        e.preventDefault();
        dropzone.classList.add('dragover');
    });
    dropzone.addEventListener('dragleave', () => dropzone.classList.remove('dragover'));
    dropzone.addEventListener('drop', e => {
        e.preventDefault();
        dropzone.classList.remove('dragover');
        if (e.dataTransfer.files.length > 0) {
            selectedFile = e.dataTransfer.files[0];
            const dataTransfer = new DataTransfer();
            dataTransfer.items.add(selectedFile);
            fileInput.files = dataTransfer.files;
            uploadBtn.disabled = false;
            uploadStatus.innerHTML = `Selected: <strong>${selectedFile.name}</strong>`;
        }
    });

    // Upload PDF
    uploadForm.addEventListener('submit', e => {
        e.preventDefault();
        if (!selectedFile) {
            uploadStatus.innerHTML = `<span class="error">âš ï¸ No file selected.</span>`;
            return;
        }
        uploadStatus.innerHTML = "â³ Uploading...";
        uploadBtn.disabled = true;

        const formData = new FormData();
        formData.append('file', selectedFile);
//updated link here
        fetch('https://agenticresearcher.onrender.com/api/upload/', {
            method: 'POST',
            headers: {'X-CSRFToken': '{{ csrf_token }}'},
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.id && data.url) {
                uploadedPdfId = data.id;
                //uploadStatus.innerHTML = `<span class="success">âœ… Upload successful!</span> PDF ID: ${data.id}`;
                uploadStatus.innerHTML = `<span class="success">âœ… Upload successful!</span>`;
                renderPDF(data.url);
                showPostUploadActions();
            } else {
                uploadStatus.innerHTML = `<span class="error">âŒ Error: ${JSON.stringify(data)}</span>`;
            }
            uploadBtn.disabled = false;
        })
        .catch(error => {
            console.error("Upload error:", error);
            uploadStatus.innerHTML = `<span class="error">âŒ Upload failed: ${error}</span>`;
            uploadBtn.disabled = false;
        });
    });

    // Render PDF
    function renderPDF(pdfUrl) {
        const loadingTask = pdfjsLib.getDocument(pdfUrl);
        loadingTask.promise.then(pdf => {
            pdfViewer.innerHTML = '';
            for (let pageNum = 1; pageNum <= pdf.numPages; pageNum++) {
                pdf.getPage(pageNum).then(page => {
                    const viewport = page.getViewport({scale: 1.0});
                    const canvas = document.createElement('canvas');
                    const context = canvas.getContext('2d');
                    canvas.height = viewport.height;
                    canvas.width = viewport.width;
                    pdfViewer.appendChild(canvas);
                    page.render({canvasContext: context, viewport: viewport});
                });
            }
        }).catch(err => {
            console.error("PDF render error:", err);
            pdfViewer.innerHTML = `<span class="error">âŒ Failed to load PDF: ${err.message}</span>`;
        });
    }

    // Show post-upload actions
    function showPostUploadActions() {
        postUploadActions.style.display = 'block';
        postUploadActions.classList.add('fade-in');
        document.getElementById('chatBtn').onclick = () => window.location.href = `/chat/${uploadedPdfId}/`;
        document.getElementById('blogBtn').onclick = () => window.location.href = `/blog/${uploadedPdfId}/`;
        document.getElementById('pptBtn').onclick = () => window.location.href = `/ppt/${uploadedPdfId}/`;
        document.getElementById('posterBtn').onclick = () => window.location.href = `/poster/${uploadedPdfId}/`;
    }
});
</script>
{% endblock %}
